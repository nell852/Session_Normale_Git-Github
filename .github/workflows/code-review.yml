name: Code Review Automatique avec Gemini

on:
  push:
    branches: ["main", "develop"]
  pull_request:
    branches: ["main"]

jobs:
  code-review:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout du code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Installer les dependances
        run: npm ci --legacy-peer-deps

      - name: ESLint
        run: npx eslint . --max-warnings=50

      - name: Prettier
        run: npx prettier --check "src/**/*.{ts,tsx,css}"

      - name: Recuperer le diff git
        id: diff
        run: |
          if git rev-parse HEAD~1 > /dev/null 2>&1; then
            git diff HEAD~1 HEAD --unified=3 > diff.txt
          else
            git show HEAD --unified=3 > diff.txt
          fi

          if [ ! -s diff.txt ]; then
            echo "Aucun changement detecte dans ce commit." > diff.txt
          fi

          echo "Contenu du diff:"
          cat diff.txt | head -50

          echo "diff_content<<EOF" >> $GITHUB_OUTPUT
          head -c 3000 diff.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Code Review avec Gemini
        id: gemini_review
        run: |
          DIFF=$(cat diff.txt | head -c 2000 | python3 -c "
          import sys
          content = sys.stdin.read()
          content = content.replace('\\\\', '\\\\\\\\').replace('\"', '\\\\\"').replace('\n', '\\\\n').replace('\r', '')
          print(content, end='')
          ")

          RESPONSE=$(curl -s -X POST \
            "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${{ secrets.GEMINI_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d "{\"contents\": [{\"parts\": [{\"text\": \"Tu es un expert en code review React TypeScript. Analyse ce diff git et fournis un rapport concis en français avec : 1) Points positifs 2) Problemes detectes 3) Suggestions d amelioration. Diff: ${DIFF}\"}]}]}")

          REVIEW=$(echo "$RESPONSE" | python3 -c "
          import sys, json
          data = json.load(sys.stdin)
          print(data['candidates'][0]['content']['parts'][0]['text'])
          " 2>/dev/null || echo "Analyse Gemini indisponible")

          echo "review<<EOF" >> $GITHUB_OUTPUT
          echo "$REVIEW" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Envoyer le rapport par email
        run: |
          python3 << 'EOF'
          import smtplib
          from email.mime.multipart import MIMEMultipart
          from email.mime.text import MIMEText
          import os

          sender   = os.environ['EMAIL_USER']
          receiver = os.environ['EMAIL_USER']
          password = os.environ['EMAIL_PASS']

          ref_name   = os.environ['GITHUB_REF_NAME']
          sha        = os.environ['GITHUB_SHA']
          sha_short  = sha[:7]
          actor      = os.environ['GITHUB_ACTOR']
          server_url = os.environ['GITHUB_SERVER_URL']
          repo       = os.environ['GITHUB_REPOSITORY']
          run_id     = os.environ['GITHUB_RUN_ID']
          review_raw = os.environ['GEMINI_REVIEW']

          # Convertir le markdown basique en HTML
          import re
          review_html = review_raw
          review_html = re.sub(r'\*\*(.+?)\*\*', r'<strong>\1</strong>', review_html)
          review_html = re.sub(r'\*(.+?)\*', r'<em>\1</em>', review_html)
          review_html = re.sub(r'^## (.+)$', r'<h3 style="color:#4f46e5;margin:16px 0 8px">\1</h3>', review_html, flags=re.MULTILINE)
          review_html = re.sub(r'^# (.+)$', r'<h2 style="color:#4f46e5;margin:16px 0 8px">\1</h2>', review_html, flags=re.MULTILINE)
          review_html = re.sub(r'^\* (.+)$', r'<li>\1</li>', review_html, flags=re.MULTILINE)
          review_html = re.sub(r'^\d+\) (.+)$', r'<li>\1</li>', review_html, flags=re.MULTILINE)
          review_html = review_html.replace('\n', '<br>')

          action_url = server_url + "/" + repo + "/actions/runs/" + run_id

          html = """
          <!DOCTYPE html>
          <html>
          <head><meta charset="UTF-8"></head>
          <body style="margin:0;padding:0;background:#f1f5f9;font-family:Arial,sans-serif;">
            <table width="100%" cellpadding="0" cellspacing="0" style="background:#f1f5f9;padding:32px 0;">
              <tr><td align="center">
                <table width="620" cellpadding="0" cellspacing="0" style="background:#ffffff;border-radius:12px;overflow:hidden;box-shadow:0 4px 24px rgba(0,0,0,0.08);">

                  <!-- HEADER -->
                  <tr>
                    <td style="background:linear-gradient(135deg,#4f46e5,#7c3aed);padding:32px 40px;text-align:center;">
                      <h1 style="color:#ffffff;margin:0;font-size:24px;font-weight:700;">&#128269; Code Review Report</h1>
                      <p style="color:#c4b5fd;margin:8px 0 0;font-size:14px;">StyleThreads — Analyse automatique par Gemini AI</p>
                    </td>
                  </tr>

                  <!-- INFOS COMMIT -->
                  <tr>
                    <td style="padding:24px 40px 0;">
                      <table width="100%" cellpadding="0" cellspacing="0">
                        <tr>
                          <td width="50%" style="padding:8px;">
                            <div style="background:#f8fafc;border-radius:8px;padding:16px;border-left:4px solid #4f46e5;">
                              <p style="margin:0;font-size:11px;color:#94a3b8;text-transform:uppercase;letter-spacing:1px;">Branche</p>
                              <p style="margin:4px 0 0;font-size:15px;font-weight:600;color:#1e293b;">""" + ref_name + """</p>
                            </div>
                          </td>
                          <td width="50%" style="padding:8px;">
                            <div style="background:#f8fafc;border-radius:8px;padding:16px;border-left:4px solid #7c3aed;">
                              <p style="margin:0;font-size:11px;color:#94a3b8;text-transform:uppercase;letter-spacing:1px;">Commit</p>
                              <p style="margin:4px 0 0;font-size:15px;font-weight:600;color:#1e293b;font-family:monospace;">""" + sha_short + """</p>
                            </div>
                          </td>
                        </tr>
                        <tr>
                          <td colspan="2" style="padding:8px;">
                            <div style="background:#f8fafc;border-radius:8px;padding:16px;border-left:4px solid #06b6d4;">
                              <p style="margin:0;font-size:11px;color:#94a3b8;text-transform:uppercase;letter-spacing:1px;">Auteur</p>
                              <p style="margin:4px 0 0;font-size:15px;font-weight:600;color:#1e293b;">&#128100; """ + actor + """</p>
                            </div>
                          </td>
                        </tr>
                      </table>
                    </td>
                  </tr>

                  <!-- ANALYSE GEMINI -->
                  <tr>
                    <td style="padding:24px 40px;">
                      <h2 style="color:#1e293b;font-size:18px;margin:0 0 16px;padding-bottom:8px;border-bottom:2px solid #e2e8f0;">
                        &#129302; Analyse Gemini AI
                      </h2>
                      <div style="background:#fafafa;border-radius:8px;padding:20px;font-size:14px;line-height:1.7;color:#334155;border:1px solid #e2e8f0;">
                        """ + review_html + """
                      </div>
                    </td>
                  </tr>

                  <!-- BOUTON -->
                  <tr>
                    <td style="padding:0 40px 32px;text-align:center;">
                      <a href=" """ + action_url + """ "
                         style="display:inline-block;background:linear-gradient(135deg,#4f46e5,#7c3aed);color:#ffffff;text-decoration:none;padding:14px 32px;border-radius:8px;font-size:15px;font-weight:600;">
                        &#128279; Voir le rapport complet sur GitHub
                      </a>
                    </td>
                  </tr>

                  <!-- FOOTER -->
                  <tr>
                    <td style="background:#f8fafc;padding:16px 40px;text-align:center;border-top:1px solid #e2e8f0;">
                      <p style="margin:0;font-size:12px;color:#94a3b8;">
                        Ce rapport a été généré automatiquement par GitHub Actions &amp; Gemini AI
                        <br>StyleThreads — """ + sha + """
                      </p>
                    </td>
                  </tr>

                </table>
              </td></tr>
            </table>
          </body>
          </html>
          """

          msg = MIMEMultipart('alternative')
          msg['Subject'] = "[StyleThreads] Code Review - " + ref_name + " - " + sha_short
          msg['From']    = sender
          msg['To']      = receiver
          msg.attach(MIMEText(html, 'html'))

          with smtplib.SMTP_SSL('smtp.gmail.com', 465) as server:
              server.login(sender, password)
              server.sendmail(sender, receiver, msg.as_string())
              print("Email envoye avec succes !")
          EOF
        env:
          EMAIL_USER: ${{ secrets.EMAIL_USER }}
          EMAIL_PASS: ${{ secrets.EMAIL_PASS }}
          GEMINI_REVIEW: ${{ steps.gemini_review.outputs.review }}
          GITHUB_REF_NAME: ${{ github.ref_name }}
          GITHUB_SHA: ${{ github.sha }}
          GITHUB_ACTOR: ${{ github.actor }}
          GITHUB_SERVER_URL: ${{ github.server_url }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_RUN_ID: ${{ github.run_id }}
